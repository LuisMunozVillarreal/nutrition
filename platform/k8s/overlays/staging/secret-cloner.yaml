apiVersion: v1
kind: ServiceAccount
metadata:
  name: secret-copier
  namespace: nutrition-staging # Placeholder, Flux/Kustomize might override
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: secret-reader-staging
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: secret-copier-binding
subjects:
  - kind: ServiceAccount
    name: secret-copier
    namespace: nutrition-staging # Placeholder
roleRef:
  kind: ClusterRole
  name: secret-reader-staging
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: secret-writer
  namespace: nutrition-staging # Placeholder
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: secret-writer-binding
  namespace: nutrition-staging # Placeholder
subjects:
  - kind: ServiceAccount
    name: secret-copier
roleRef:
  kind: Role
  name: secret-writer
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: batch/v1
kind: Job
metadata:
  name: secret-cloner
  namespace: nutrition-staging # Placeholder
spec:
  template:
    spec:
      serviceAccountName: secret-copier
      containers:
        - name: copier
          image: bitnami/kubectl:latest
          command:
            - /bin/sh
            - -c
            - |
              # Secrets to copy
              SECRETS="nutrition-webapp-nextauth-secret nutrition-postgresql nutrition-django-secret-key nutrition-gemini-api-key nutrition-gcp-db-backup-credentials"
              SOURCE_NS="nutrition-staging"
              # Current namespace is injected by Downward API or just assumed to be where the pod is running
              TARGET_NS=$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace)

              for SECRET in $SECRETS; do
                echo "Copying $SECRET from $SOURCE_NS to $TARGET_NS..."
                kubectl get secret $SECRET -n $SOURCE_NS -o json | \
                jq 'del(.metadata.namespace,.metadata.resourceVersion,.metadata.uid,.metadata.creationTimestamp,.metadata.ownerReferences)' | \
                kubectl apply -n $TARGET_NS -f -
              done
      restartPolicy: OnFailure
