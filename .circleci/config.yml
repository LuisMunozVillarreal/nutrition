version: 2.1

orbs:
  kubernetes: circleci/kubernetes@1.3.1

parameters:
  backend-image:
    type: string
    default: "luismunozvillarreal/nutrition-backend:0.101.0"
  uv-venv:
    type: string
    default: "/home/backend/project/backend/.venv/"
  postgresql-image:
    type: string
    default: "cimg/postgres:17.4"
  docker-image:
    type: string
    default: "docker:24.0.9-git"

executors:
  python:
    docker:
      - image: << pipeline.parameters.backend-image >>
    environment:
      PATH: "/usr/local/bin:/usr/local/sbin:/usr/sbin:/usr/bin:/sbin:/bin:/root/.local/bin"
      GEMINI_API_KEY: "TestingApiKey"
      SECRET_KEY: "TestingSecretKey"
  python-postgresql:
    docker:
      - image: << pipeline.parameters.backend-image >>
      - image: << pipeline.parameters.postgresql-image >>
        environment:
          POSTGRES_USER: nutrition
    environment:
      GEMINI_API_KEY: "TestingApiKey"
      SECRET_KEY: "TestingSecretKey"

commands:
  python-dependencies:
    steps:
      - checkout:
          path: ~/project
      - restore_cache:
          name: Restore Python Dependencies
          keys:
            - python-packages-{{ checksum "uv.lock" }}-v1
      - run:
          name: Install Python Dependencies
          command: uv sync
      - save_cache:
          name: Save Python Dependencies
          key: python-packages-{{ checksum "uv.lock" }}-v1
          paths:
            - << pipeline.parameters.uv-venv >>

  gcp-credentials:
    steps:
      - run:
          name: Create GCP credential JSON
          command: echo $GCLOUD_SERVICE_KEY > nutrition-gcp-db-backup-credentials.json

  docker-login:
    steps:
      - run:
          name: Docker Login
          command: echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_LOGIN" --password-stdin

  validate:
    parameters:
      env:
        type: string
    steps:
      - run:
          name: << parameters.env >>
          command: make << parameters.env >>

jobs:
  pytest:
    working_directory: ~/project/backend
    executor: python-postgresql
    steps:
      - python-dependencies
      - gcp-credentials
      - validate:
          env: pytest
  bandit:
    working_directory: ~/project/backend
    executor: python
    steps:
      - python-dependencies
      - validate:
          env: bandit
  flake8:
    working_directory: ~/project/backend
    executor: python
    steps:
      - python-dependencies
      - validate:
          env: flake8
  black:
    working_directory: ~/project/backend
    executor: python
    steps:
      - python-dependencies
      - validate:
          env: black
  mypy:
    working_directory: ~/project/backend
    executor: python
    steps:
      - python-dependencies
      - gcp-credentials
      - validate:
          env: mypy
  pylint:
    working_directory: ~/project/backend
    executor: python
    steps:
      - python-dependencies
      - gcp-credentials
      - validate:
          env: pylint
  pylint-tests:
    working_directory: ~/project/backend
    executor: python
    steps:
      - python-dependencies
      - gcp-credentials
      - validate:
          env: pylint-tests
  pydocstyle:
    working_directory: ~/project/backend
    executor: python
    steps:
      - python-dependencies
      - validate:
          env: pydocstyle
  pydocstyle-tests:
    working_directory: ~/project/backend
    executor: python
    steps:
      - python-dependencies
      - validate:
          env: pydocstyle-tests

  backend-docker-build-tag-push:
    working_directory: ~/project/backend
    docker:
      - image: << pipeline.parameters.docker-image >>
    steps:
      - checkout:
          path: ~/project
      - setup_remote_docker:
          version: docker24
          docker_layer_caching: true
      - docker-login
      - run:
          name: Build, Tag and Push Backend
          command: |
             apk add --no-cache make
             TAG=$CIRCLE_SHA1 make docker-build-tag-push

  webapp-docker-build-tag-push:
    working_directory: ~/project/webapp
    docker:
      - image: << pipeline.parameters.docker-image >>
    steps:
      - checkout:
          path: ~/project
      - setup_remote_docker:
          version: docker24
          docker_layer_caching: true
      - docker-login
      - run:
          name: Build, Tag and Push Webapp
          command: |
             apk add --no-cache make
             TAG=$CIRCLE_SHA1 make docker-build-tag-push

  deploy-preview:
    working_directory: ~/project
    docker:
      - image: cimg/python:3.12
    steps:
      - checkout
      - add_ssh_keys:
          fingerprints:
            - "SHA256:eUMnZKevcHtp4GT33VoOns8oPBGWlMP3oPHfhmlfW9k"
      - kubernetes/install
      - run:
          name: Setup Kubeconfig
          command: |
             mkdir -p $HOME/.kube
             echo "$KUBECONFIG_DATA_BASE64" | base64 -d > $HOME/.kube/config
             chmod 600 $HOME/.kube/config
      - run:
          name: Generate Flux Preview
          command: |
            python3 .circleci/scripts/generate_flux_preview.py "$CIRCLE_BRANCH" "$CIRCLE_SHA1"
      - run:
          name: Wait for Deployment Readiness
          no_output_timeout: 10m
          command: |
            SANITIZED_BRANCH=$(python3 .circleci/scripts/sanitise_branch.py "$CIRCLE_BRANCH")
            TARGET_NAMESPACE="nutrition-staging--${SANITIZED_BRANCH}"
            
            echo "Waiting for Flux Kustomization..."
            kubectl wait --for=condition=ready kustomization/nutrition-preview-${SANITIZED_BRANCH} -n flux-system --timeout=600s
            
            echo "Waiting for backend pods..."
            kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=backend -n ${TARGET_NAMESPACE} --timeout=600s
            
            echo "Checking backend rollout status..."
            kubectl rollout status deployment/nutrition-backend -n ${TARGET_NAMESPACE} --timeout=600s
            
            echo "Waiting for webapp pods..."
            kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=webapp -n ${TARGET_NAMESPACE} --timeout=600s
            
            echo "Checking webapp rollout status..."
            kubectl rollout status deployment/nutrition-webapp -n ${TARGET_NAMESPACE} --timeout=600s

  deploy-production:
    working_directory: ~/project
    docker:
      - image: cimg/python:3.12
    steps:
      - checkout
      - add_ssh_keys:
          fingerprints:
            - "SHA256:eUMnZKevcHtp4GT33VoOns8oPBGWlMP3oPHfhmlfW9k"
      - kubernetes/install
      - run:
          name: Setup Kubeconfig
          command: |
             mkdir -p $HOME/.kube
             echo "$KUBECONFIG_DATA_BASE64" | base64 -d > $HOME/.kube/config
             chmod 600 $HOME/.kube/config
      - run:
          name: Patch Production Flux Kustomization
          command: |
            kubectl patch kustomization nutrition-production -n flux-system --type='merge' -p='{"spec": {"images": [{"name": "luismunozvillarreal/nutrition-backend", "newTag": "'$CIRCLE_SHA1'"}, {"name": "luismunozvillarreal/nutrition-webapp", "newTag": "'$CIRCLE_SHA1'"}]}}'
      - run:
          name: Wait for Production Readiness
          no_output_timeout: 10m
          command: |
            echo "Waiting for Flux Kustomization reconciliation..."
            kubectl annotate kustomization nutrition-production -n flux-system reconcile.fluxcd.io/requestedAt=$(date +%s) --overwrite
            kubectl wait --for=condition=ready kustomization/nutrition-production -n flux-system --timeout=600s
            
            echo "Waiting for backend pods..."
            kubectl rollout status deployment/nutrition-backend -n nutrition-production --timeout=600s
            
            echo "Waiting for webapp pods..."
            kubectl rollout status deployment/nutrition-webapp -n nutrition-production --timeout=600s

  cypress-e2e:
    working_directory: ~/project
    docker:
      - image: cimg/node:22.12.0-browsers
    steps:
      - checkout
      - kubernetes/install
      - run:
          name: Setup Kubeconfig
          command: |
             mkdir -p $HOME/.kube
             echo "$KUBECONFIG_DATA_BASE64" | base64 -d > $HOME/.kube/config
             chmod 600 $HOME/.kube/config
      - run:
          name: Install Dependencies
          working_directory: ~/project/webapp
          command: npm ci
      - run:
          name: Create Test User
          command: |
             SANITIZED_BRANCH=$(python3 .circleci/scripts/sanitise_branch.py "$CIRCLE_BRANCH")
             NAMESPACE="nutrition-staging--${SANITIZED_BRANCH}"
             echo "Creating test user in namespace: $NAMESPACE"
             # Create user user@example.com / password123
             kubectl exec -n "$NAMESPACE" deployment/nutrition-backend -- python3 manage.py shell -c "from apps.users.models import User; import datetime; User.objects.filter(email='user@example.com').delete(); User.objects.create_user(email='user@example.com', password='password123', first_name='Nutrition', last_name='User', date_of_birth=datetime.date(1990, 1, 1), height=180.0)"
      - run:
          name: Run Cypress
          working_directory: ~/project/webapp
          command: |
             SANITIZED_BRANCH=$(python3 ../.circleci/scripts/sanitise_branch.py "$CIRCLE_BRANCH")
             
             if [ -z "$BASE_DOMAIN" ]; then
               echo "BASE_DOMAIN not set, fetching from cluster..."
               BASE_DOMAIN=$(kubectl get configmap cluster-settings -n flux-system -o jsonpath='{.data.BASE_DOMAIN}')
             fi
             
             if [ -z "$BASE_DOMAIN" ]; then
               echo "Error: BASE_DOMAIN could not be determined."
               exit 1
             fi
             
             REAL_DOMAIN="staging--${SANITIZED_BRANCH}.${BASE_DOMAIN}"
             REAL_IP=$(python3 -c "import socket; print(socket.gethostbyname('$REAL_DOMAIN'))")
             echo "$REAL_IP testing-domain" | sudo tee -a /etc/hosts
             
             export CYPRESS_BASE_URL="https://testing-domain"
             npm run cypress:run
      - store_artifacts:
          path: ~/project/webapp/cypress/videos
      - store_artifacts:
          path: ~/project/webapp/cypress/screenshots

workflows:
  version: 2
  ValidationWorkflow:
    jobs:
      - pytest
      - bandit
      - flake8
      - black
      - mypy
      - pylint
      - pylint-tests
      - pydocstyle
      - pydocstyle-tests
      - backend-docker-build-tag-push:
          context:
            - Docker
      - webapp-docker-build-tag-push:
          context:
            - Docker
      - deploy-preview:
          context:
            - kubeconfig
          requires:
            - backend-docker-build-tag-push
            - webapp-docker-build-tag-push
          filters:
            branches:
              ignore:
                - main
      - deploy-production:
          context:
            - kubeconfig
          requires:
            - backend-docker-build-tag-push
            - webapp-docker-build-tag-push
          filters:
            branches:
              only:
                - main
      - cypress-e2e:
          context:
            - kubeconfig
          requires:
            - deploy-preview
